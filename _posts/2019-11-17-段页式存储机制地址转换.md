---
layout: post
title: IA32/Linux 段页式地址转换
categories: System
description: IA32/Linux 段页式地址转换
keywords: IA32/Linux 段页式地址转换
---

## 1. 段选择符和段寄存器

<img src="C:\Users\64451\Pictures\md_images\image-20191117161525461.png" alt="image-20191117161525461" style="zoom:50%;" />

如上图就是一个段选择符的构造，共16位，

- 高13位用来表示该段在段描述符表中的索引；
- TI=1：局部描述符表（LDT）  TI=0：全局描述符表（GDT）
- RPL(Request Privilege Level)：0是内核特权级，3是用户态

这个段选择符存在段寄存器里，IA32里面共有6个段寄存器：

- CS：代码段寄存器，**<u>CS中的RPL表示当前CPU的特权级</u>**（Current Privilege Level）
- SS：栈段寄存器
- DS：数据段寄存器
- ES, FS, GS：任意段

## 2. 段描述符

段描述符类似分页方式中的页表项，也可以称为段表项。

 ![img](C:\Users\64451\Pictures\md_images\u=2271433171,2538321423&fm=26&gp=0.jpg) 

 

段描述符共8个字节：

- 段限界（段中的最大页号）：高16-19位，低0-15位，共20位
- 段基地址：高24-31位，0-7位，低16-31位，共32位
- 段中页大小G：高23位，共1位。
  - G=0：段中页大小为1B，那么最大段也就1MB
  - G=1：段中页大小为4KB，那么最大段就有4GB那么大
- 地址和数据宽度D/B：高22位，共一位。
  - D=1, 地址和数据32位
  - D=0， 地址和数据16位
- 段是否全部在主存中P：高15位，共一位。
  - P=1：存在，分页机制永远是1
- 描述符特权级DPL：高13-14位，CPL<=DPL必须成立
  - DPL=3时，CPL是多少都可以访问该段
  - DPL=0时，CPL=0才可以访问该段
- 描述符类型S：高12位
  - S=0：系统控制描述符
  - S=1：用户的代码和数据
- 描述符类型TYPE：高8-11位
  - 高8位：段是否被访问过
  - 高9-11位：访问权限or描述符的类型

## 3.段描述符表

描述符表类似分页机制下的页表，实际上可以称之为“段表”，主要由三种类型：

- GDT：仅有一个，系统所有进程共享，内核代码和数据段所在的表，LDT的描述符，TSS任务段描述符也在GDT里
- LDT：可以有多个，某个进程专用的段表
- IDT(中断描述符表)

## 4.用户不可见寄存器

### 4.1 描述符cache

​	显然描述符表也是类似页表一样频繁被MMU访问的数据，所以也要建立类似TLB那样的“快段”。我们只需在段寄存器中载入一个新段选择符时，把这段选择符指向的段描述符加载到cache中就好，只需加载32位段基地址，20位段限界，和2位的DPL即可。

### 4.2 描述符表寄存器

​	到这里其实有一个BUG：段选择符选择不了一个具体的段描述符，因为找不到段描述符表。所以有了段描述符表寄存器GDTR,LDTR,IDTR，GDTR,IDTR 48位

- 高32位：段描述符表首地址
- 低16位：段描述符表限长（所以描述符表最长64KB）

而LDTR只有16位，原因很简单，每个进程的LDT也被认为是一个特殊的段，有一个段描述符，这个段描述符存在于GDT里，所以LDTR只要存一个段选择符，指向GDT中所在进程的段描述符即可。这个段描述符非常常用，自然可以加载到描述符cache里。

### 4.3 任务段选择符寄存器（TR）

- 任务段（TSS）是在任务（进程）切换的时候用来保存当前进程上下文信息的段，它同时还保存了当前进程的许多重要静态信息，比如CR3，各个特权级的栈指针和段选择符，但是这些静态信息无需在上下文切换中被更新。
- TR只有16位，同LDTR一样，表示了TSS的选择符，由于任务段也非常重要，自然也可以被cache进描述符cache中。





------

==到此为止，48位逻辑地址已经可以转换为32位线性地址了。==

------





## 5. 控制寄存器

### 5.1 CR0 控制寄存器

- 分页允许位PG位：0表示线性地址直接用作物理地址，1表示分页机制开启。



### 5.2 CR1 控制寄存器

存放引起缺页的线性地址

### 5.3 CR3 控制寄存器

存放页表的基地址的寄存器

